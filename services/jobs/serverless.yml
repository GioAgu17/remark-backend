service: jobs
package:
  individually: true
useDotenv: true
plugins:
  - serverless-bundle # Package our functions with Webpack
  - serverless-offline
  - serverless-dotenv-plugin # Load .env as environment variables

custom: ${file(../../serverless.common.yml):custom}
provider:
  name: aws
  runtime: nodejs12.x
  region: us-east-2
  environment:
    userTableName: !ImportValue '${self:custom.sstApp}-ExtUserTableName'
    offerTableName: !ImportValue '${self:custom.sstApp}-ExtNewOffersTableName'
    offerTableIndex: ${env:OFFER_TABLE_INDEX}
    expiredOffersTable: !ImportValue '${self:custom.sstApp}-ExtExpiredOffersTableName'
    collaborationTableName: !ImportValue '${self:custom.sstApp}-ExtNewCollaborationTableName'
    bucketName: !ImportValue '${self:custom.sstApp}-ExtAttachmentsBucketName'
    connectionChatTableName: !ImportValue '${self:custom.sstApp}-ExtConnectionChatTableName'
    conversationChatTableName: !ImportValue '${self:custom.sstApp}-ExtConversationChatTableName'
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Scan
        - dynamodb:Query
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:DescribeTable
        - dynamodb:BatchWriteItem
        - dynamodb:BatchDeleteItem
      # Restrict our IAM role permissions to
      # the specific table for the stage
      Resource:
        - !ImportValue '${self:custom.sstApp}-ExtUserTableArn'
        - !ImportValue '${self:custom.sstApp}-ExtExpiredOffersTableArn'
        - !ImportValue '${self:custom.sstApp}-ExtNewOffersTableArn'
        - !ImportValue '${self:custom.sstApp}-ExtNewOffersTableArnIndex'
        - !ImportValue '${self:custom.sstApp}-ExtAttachmentsBucketArn'
functions:
  moveOffers:
    handler: moveOffers.main
    events:
      #scheduled every day at 4 am
      - schedule: cron(0 4 * * ? *)
  statistics:
    handler: statistics.main
    #events:
      #scheduled every day at 3 am
      #schedule: cron(0 3 * * ? *)
  closeCollabs:
    handler: closeCollabs.main
    events:
      #scheduled every day at 6 am
      - schedule: cron(0 6 * * ? *)
